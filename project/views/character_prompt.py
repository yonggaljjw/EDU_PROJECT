import openai
import os
from datetime import datetime
# ìºë¦­í„° í˜ë¥´ì†Œë‚˜ ì„¤ì •ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸
# chat_character.pyì—ì„œ í™œìš©í•  ê²ƒ

# ìºë¦­í„° ì½”ë“œ â†” í•œê¸€ ì´ë¦„ ë§¤í•‘
character_name_mapping = {
    "hanul": "í•˜ëŠ˜",
    "jihan": "ì§€í•œ",
    "isol": "ì´ì†”"
}

# ìºë¦­í„°ë³„ í”„ë¡¬í”„íŠ¸
character_prompts = {
    "hanul": """[ìºë¦­í„° í˜ë¥´ì†Œë‚˜ ì„¤ì •]
ë‹¹ì‹ ì€ 17ì„¸ ì˜ˆìˆ ê³ ë“±í•™êµ 2í•™ë…„ ì´í•˜ëŠ˜ì…ë‹ˆë‹¤. ì—ë„ˆì§€ê°€ ë„˜ì¹˜ê³ , ë°ê³  ê¸ì •ì ì¸ ì„±ê²©ì…ë‹ˆë‹¤. ìƒëŒ€ë°©ì˜ ê¸´ì¥ì„ í’€ì–´ì£¼ê³  í¸í•˜ê²Œ ëŒ€í™”ë¥¼ ì´ëŒë©°, ì‹¤íŒ¨ ê²½í—˜ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë‚˜ëˆ„ê³  "ê´œì°®ì•„, ê¸¸ì€ í•˜ë‚˜ê°€ ì•„ë‹ˆì•¼!"ë¼ê³  ê²©ë ¤í•´ì¤ë‹ˆë‹¤.
ë°˜ë§ê³¼ ì¡´ëŒ“ë§ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„ì–´ ì‚¬ìš©í•˜ëŠ” ì¹œê·¼í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
""",
    
    "jihan": """[ìºë¦­í„° í˜ë¥´ì†Œë‚˜ ì„¤ì •]
ë‹¹ì‹ ì€ 22ì„¸ ê²½ì˜í•™ê³¼ ëŒ€í•™ìƒ ì„ ë°° ê¹€ì§€í•œì…ë‹ˆë‹¤. ì°¨ë¶„í•˜ê³  ë“ ë“ í•œ ì„±ê²©ìœ¼ë¡œ, ìƒëŒ€ë°©ì´ í¸í•˜ê²Œ ëŠë¼ë„ë¡ ëŒ€í™”í•©ë‹ˆë‹¤.
ì²˜ìŒ ëŒ€í™”í•  ë•ŒëŠ” "í˜¹ì‹œ ë‚´ê°€ í¸í•˜ê²Œ ë°˜ë§ë¡œ ì´ì•¼ê¸°í•´ë„ ê´œì°®ì„ê¹Œ?"ë¼ê³  ë¬¼ì–´ë³¸ í›„, í—ˆë½ë°›ìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ë§ì„ ì„ì–´ ì‚¬ìš©í•˜ì„¸ìš”. í—ˆë½ë°›ì§€ ëª»í•˜ë©´ ì¡´ëŒ“ë§ì„ ìœ ì§€í•˜ì„¸ìš”.
""",
    
    "isol": """[ìºë¦­í„° í˜ë¥´ì†Œë‚˜ ì„¤ì •]
ë‹¹ì‹ ì€ 26ì„¸ AI ê°œë°œ ì§ì¥ì¸ ì´ì†”ì…ë‹ˆë‹¤. ì¡°ìš©í•˜ê³  ë¶€ë“œëŸ¬ìš´ ì„±ê²©ì´ë©°, í•­ìƒ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
í•™ìƒì´ë‚˜ ë¹„ì „ê³µìê°€ AIì— ëŒ€í•´ ì–´ë µì§€ ì•Šê²Œ ëŠë¼ë„ë¡ ë°°ë ¤í•˜ë©°, "ì¡°ê¸‰í•´í•˜ì§€ ì•Šì•„ë„ ëœë‹¤"ëŠ” ë©”ì‹œì§€ë¥¼ ì „í•©ë‹ˆë‹¤.
"""
}

def build_prompt(character_name, student_question, retrieved_conversations):
    """
    ìºë¦­í„° í”„ë¡¬í”„íŠ¸ + í•™ìƒ ì§ˆë¬¸ + ê²€ìƒ‰ëœ ìƒë‹´ ê¸°ë¡ì„ ì¡°í•©í•´ ìµœì¢… í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜

    Args:
        character_name (str): ì„ íƒí•œ ìºë¦­í„° ì´ë¦„ (ex: "í•˜ëŠ˜(hanul)", "ì§€í•œ(jihan)", "ì´ì†”(isol)")
        student_question (str): í•™ìƒì´ ì…ë ¥í•œ ì§ˆë¬¸
        retrieved_conversations (list): ê²€ìƒ‰ëœ ìœ ì‚¬ ìƒë‹´ ê¸°ë¡ ë¦¬ìŠ¤íŠ¸

    Returns:
        str: LLMì— ë³´ë‚¼ ìµœì¢… í”„ë¡¬í”„íŠ¸
    """
    base_prompt = character_prompts.get(character_name)
    if not base_prompt:
        raise ValueError("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìºë¦­í„°ì…ë‹ˆë‹¤.")

    convo_text = "\n".join([f"- {c}" for c in retrieved_conversations])

    final_prompt = f"""
{base_prompt}

[ìƒë‹´ ìƒí™©]
{student_question}

[ì°¸ê³ í•  ìƒë‹´ ê¸°ë¡]
{convo_text}

[ë‹µë³€ ì§€ì¹¨]
ìºë¦­í„° ì„¤ì •ì„ ìœ ì§€í•˜ë©° í•™ìƒì—ê²Œ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.
"""
    return final_prompt


# LLM í˜¸ì¶œ í•¨ìˆ˜
def call_llm_api(prompt):
    openai.api_key = os.getenv("OPENAI_API_KEY")
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[
            {"role": "system", "content": "ë„ˆëŠ” í•™ìƒ ë‹¤ì–‘í•œ ê³ ë¯¼ì„ ìƒë‹´í•´ì£¼ëŠ” ìºë¦­í„°ì•¼."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.8,
        max_tokens=200
    )
    return response['choices'][0]['message']['content'].strip()

# âœ¨ ì¶”ê°€í•  "ì²« ì¸ì‚¬ë§ ìƒì„± í•¨ìˆ˜"
def generate_greeting(character_code):
    character_persona = character_prompts.get(character_code, "")
    if not character_persona:
        return "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì´ë“  í¸í•˜ê²Œ ì´ì•¼ê¸°í•´ë´ìš”. ğŸ˜Š"  # fallback

    current_time = datetime.now().strftime("%H:%M")

    prompt = f"""
{character_persona}

[ì§€ì‹œì‚¬í•­]
- ìœ„ ìºë¦­í„° í˜ë¥´ì†Œë‚˜ì— ë§ê²Œ í•™ìƒê³¼ì˜ ì²« ì¸ì‚¬ë§ì„ ì‘ì„±í•˜ì„¸ìš”.
- ê³ ì •ëœ ë¬¸ì¥ì´ ì•„ë‹ˆë¼ ë§¤ë²ˆ ìì—°ìŠ¤ëŸ½ê³  ì¹œê·¼í•˜ê²Œ í‘œí˜„í•´ì£¼ì„¸ìš”.
- í˜„ì¬ ì‹œê°„ì€ {current_time}ì…ë‹ˆë‹¤.
- 2ë¬¸ì¥ ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
"""

    return call_llm_api(prompt)